{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nivel 1: Capa de Aplicaci√≥n</title>
        <link rel="stylesheet" href="{% static 'aplicacion/estudiante/niveles.css' %}">

    <link rel="stylesheet" href="{% static 'aplicacion/style.css' %}">


</head>
<body>
    
    {% if user.is_authenticated %}
    
    <h1 class="title" style="margin-top: 30px; margin-bottom: 10px;">AVENTURA TCP/IP: CARRERA DE CAPAS üèÅ</h1>
  

    <div class="game-area">
        
        <div class="game-profile-meta">
            Jugando como: <strong>{{ user.alias|default:user.username }}</strong> | Rol: {{ user.rol }}
        </div>
        
        <h2 style="color: #0077B6; margin-bottom: 5px;">Nivel 1: Capa de Aplicaci√≥n</h2>
        <p style="text-align: center; font-style: italic; margin-bottom: 15px;">Pregunta <span id="current-q-number">1</span> de 10. ¬°Cada acierto te acerca a la Fibra √ìptica!</p>
        
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <form id="quiz-form" onsubmit="return false;"> 
            <div id="questions-container">
                </div>
            
            <div id="score-results" style="display: none;">
                <div class="score-display">Puntuaci√≥n Final: <span id="final-score"></span>/10</div>
                <div id="feedback-final" class="feedback"></div>
                
                <div id="review-container">
                    <h4>Revisi√≥n Detallada (Aciertos y Errores)</h4>
                    <div id="review-list"></div>
                </div>
            </div>

            <div class="nav-controls">
                <button type="button" id="prev-btn" disabled>‚Üê Anterior</button>
                <button type="button" id="check-btn">Verificar</button>
                <button type="button" id="next-btn" disabled>Siguiente ‚Üí</button>
                <button type="button" id="finish-btn" style="display:none;">Finalizar</button>
            </div>
        </form>

        <a href="{% url 'perfil_estudiante' %}" class="link-return" style="display: block; margin-top: 20px;">Volver al Men√∫ de Niveles</a>
    </div>

    <script>
        window.QUIZ_CONFIG = {
          saveResultUrl: "{% url 'save_quiz_result' %}",
          imgFibra: "{% static 'aplicacion/images/fibra.svg' %}",
          imgCat6: "{% static 'aplicacion/images/cat6.svg' %}",
          imgCat35: "{% static 'aplicacion/images/cat3_5.svg' %}",
          imgDnsDiagram: "{% static 'aplicacion/images1/diagrama_dns.png' %}",
            imgCorreoDiagram: "{% static 'aplicacion/images1/diagrama_correo_vacio.png' %}",
            imgHttpMensaje: "{% static 'aplicacion/images1/mensajeHttp.png' %}"
        };

        // --- BANCO DE PREGUNTAS COMPLETO (15 √≠tems) ---
        // Usamos FULL_QUIZ_BANK para almacenar las 15 preguntas.
        window.FULL_QUIZ_BANK = [
    // P1 Original: DRAG & DROP - Funci√≥n a Protocolo (Mantener)
    { id: 1, type: 'drag_drop', text: " ¬°Asocia la funci√≥n con el Protocolo que la realiza!",
        drag_items: [
            { value: 'web_request', label: 'Petici√≥n de una p√°gina web' },
            { value: 'mail_address', label: 'Traducci√≥n de nombre a IP' },
            { value: 'encrypted_remote', label: 'Acceso remoto cifrado' },
            { value: 'mailbox_access', label: 'Gesti√≥n de tu buz√≥n de correo' }
        ],
        drop_zones: [
            { function: 'http_p', label: 'Protocolo HTTP/S' },
            { function: 'dns_p', label: 'Protocolo DNS' },
            { function: 'ssh_p', label: 'Protocolo SSH' },
            { function: 'imap_p', label: 'Protocolo IMAP' }
        ],
        correct_map: { 'http_p': 'web_request', 'dns_p': 'mail_address', 'ssh_p': 'encrypted_remote', 'imap_p': 'mailbox_access' },
        hint_if_wrong: "Recuerda la funci√≥n principal de cada protocolo: ¬øCu√°l est√° asociado con la encriptaci√≥n? ¬øCu√°l usa TCP en el puerto 80/443? ¬øCu√°l almacena mensajes en el buz√≥n?",
        answer: {}, checked: false, score_value: 1, topic: 'Protocolos'
    },
  
 
    { id: 2, type: 'mc', text: "¬øCu√°l es la PDU principal (Unidad de Datos) que maneja la Capa de Aplicaci√≥n?", 
    options: ['Segmentos', 'Tramas', 'Mensajes', 'Paquetes'], 
    correct_answer: 'Mensajes', 
    explanation: "La Capa de Aplicaci√≥n trabaja con 'Mensajes', datos a nivel de usuario.", 
    hint_if_wrong: "Recuerda que esta capa trabaja con datos a nivel de usuario.", answer: null, checked: false, score_value: 1, topic: 'Concepto' },
   
    // P9 Original: OPCI√ìN M√öLTIPLE (Puerto simple)
    { id: 3, type: 'mc', 
    text: " El protocolo utilizado para la navegaci√≥n web segura (HTTPS) usa el puerto:", 
    options: ['21', '80', '443', '110'], correct_answer: '443', 
    explanation: "HTTPS utiliza el puerto 443 por defecto para la comunicaci√≥n cifrada (TLS/SSL).", 
    hint_if_wrong: "El puerto 80 es para HTTP sin cifrado. HTTPS a√±ade cifrado TLS/SSL y usa otro puerto.", answer: null, checked: false, score_value: 1, topic: 'HTTP' },
    // P10 Original: OPCI√ìN M√öLTIPLE (Protocolo Correo)
    { id: 14, type: 'mc', text: " Si un protocolo de correo mantiene copias en el servidor (IMAP), ¬øcu√°l utiliza la descarga y eliminaci√≥n simple?", options: ['SMTP', 'IMAP', 'POP3', 'FTP'], correct_answer: 'POP3', 
    explanation: "POP3 (Post Office Protocol 3) t√≠picamente descarga y elimina el correo del servidor.",
     hint_if_wrong: "POP3 descarga tu correo y lo elimina del servidor. IMAP lo deja en el servidor. SMTP es para enviar.", answer: null, checked: false, score_value: 1, topic: 'Correo' },

    
    // Q11: DNS - Tipo de registro A
    { id: 5, type: 'mc', text: "¬øQu√© tipo de registro DNS (RR) se utiliza para asociar un nombre de dominio con la direcci√≥n IPv4 de un host?", 
        options: ['A (Address)', 'NS (Name Server)', 'CNAME (Canonical Name)', 'MX (Mail Exchange)'], 
        correct_answer: 'A (Address)', 
        explanation: "El registro de tipo A es el registro fundamental que mapea un nombre de host a su correspondiente direcci√≥n IPv4 de 32 bits.", 
        hint_if_wrong: "El nombre de este registro es una abreviatura de la palabra que describe lo que almacena: la ubicaci√≥n del host.",
        answer: null, checked: false, score_value: 1, topic: 'DNS'
    },
    { 
    id: 6, 
    type: 'mc', 
    text: "Q14. ¬øPara qu√© sirve el mecanismo de GET condicional en HTTP?",
    options: [
        'Para permitir que una cach√© web verifique si su copia de un objeto est√° actualizada sin tener que descargar el objeto completo.',
        'Para solicitar diferentes partes de un objeto grande en solicitudes separadas, √∫til para streaming de video.',
        'Para descargar un objeto solo si el usuario cumple con ciertas condiciones de autenticaci√≥n, como tener una cookie v√°lida.',
        'Para solicitar una versi√≥n cifrada de un objeto web si el cliente soporta SSL/TLS.'
    ],
    correct_answer: 'Para permitir que una cach√© web verifique si su copia de un objeto est√° actualizada sin tener que descargar el objeto completo.',
    explanation: "El cliente (o cach√©) env√≠a la fecha de su copia en la cabecera 'If-Modified-Since'. Si el objeto no ha cambiado, el servidor responde con '304 Not Modified' (sin el objeto), ahorrando ancho de banda.",
    
    hint_if_wrong: "Este mecanismo se utiliza para evitar el desperdicio de ancho de banda y el incremento del retardo cuando el servidor tiene que volver a enviar un archivo grande que el cliente ya tiene. ",
    answer: null, checked: false, score_value: 1, topic: 'HTTP'
},
    // Q15: HTTP - Conexiones Persistentes
    { id: 7, type: 'mc', text: "¬øCu√°l es la principal ventaja de utilizar conexiones HTTP persistentes en lugar de no persistentes?",
        options: [
            'Permite que el servidor almacene informaci√≥n sobre las solicitudes anteriores del cliente (estado de la sesi√≥n).',
            'Se garantiza la entrega de datos sin errores, lo cual no ocurre en las conexiones no persistentes.',
            'Se reduce la sobrecarga y la latencia al reutilizar la misma conexi√≥n TCP para m√∫ltiples solicitudes y respuestas entre el cliente y el servidor.',
            'Aumenta la seguridad de la transferencia de datos al cifrar cada objeto de forma individual.'
        ],
        correct_answer: 'Se reduce la sobrecarga y la latencia al reutilizar la misma conexi√≥n TCP para m√∫ltiples solicitudes y respuestas entre el cliente y el servidor.',
        explanation: "Al evitar el establecimiento de una nueva conexi√≥n TCP para cada objeto (que requiere un RTT), se mejora significativamente el rendimiento.",
        hint_if_wrong: "Considere el costo en tiempo y recursos de establecer una conexi√≥n TCP para cada objeto de una p√°gina web.",
        answer: null, checked: false, score_value: 1, topic: 'HTTP'
    },
    // Q16: DNS - Tipo de registro MX
    { id: 8, type: 'mc', text: "¬øQu√© tipo de registro de recurso (RR) DNS se utiliza para asociar un nombre de dominio con el servidor de correo responsable de recibir correos electr√≥nicos para ese dominio?",
         options: ['A (Address)', 'NS (Name Server)', 'CNAME (Canonical Name)', 'MX (Mail Exchange)'], 
        correct_answer: 'MX (Mail Exchange)',
        explanation: "El registro MX (Mail Exchange) especifica los servidores de correo autorizados para recibir correos para un dominio espec√≠fico.",
        hint_if_wrong: "Piense en el protocolo utilizado para el intercambio de correos entre servidores y el tipo de registro que lo facilitar√≠a.",
        answer: null, checked: false, score_value: 1, topic: 'DNS'
    },
    // Q17: DNS - Primera consulta
 // MODIFICACI√ìN NECESARIA EN EL HTML
{ 
    id: 9, 
    type: 'mc', 
    text: "[IMG_DNS_DIAGRAM] Observa la siguiente imagen de resoluci√≥n DNS. En el Paso 1 (la consulta inicial del 'Host solicitante') ¬øA qu√© entidad se dirige?", 
    options: [
        'Al servidor DNS autoritativo para el dominio solicitado.', 
        'Al servidor DNS local.', 
        'Al servidor DNS ra√≠z.', 
        'Al servidor DNS TLD.'
    ],
    correct_answer: 'Al servidor DNS local.',
    explanation: "La configuraci√≥n de red de un host (cse.nyu.edu) casi siempre apunta a un **servidor DNS local** (dns.nyu.edu) que act√∫a como primer punto de contacto para todas las consultas (Paso 1).",
    hint_if_wrong: "F√≠jate a d√≥nde apunta la flecha etiquetada con el n√∫mero 1, saliendo del 'Host solicitante'.",
    answer: null, 
    checked: false, 
    score_value: 1, 
    topic: 'DNS'
},
    // Q18: HTTP - Cookies
    { id: 10, type: 'mc', text: " ¬øCu√°l es la funci√≥n principal de las 'cookies' en el protocolo HTTP?",
        options: [
            'Cifrar la comunicaci√≥n entre el cliente y el servidor para proteger la privacidad.',
            'Acelerar la carga de p√°ginas web almacenando objetos en el cliente.',
            'Validar la integridad de los datos transmitidos para evitar la corrupci√≥n.',
            'Permitir que un servidor web mantenga informaci√≥n de estado sobre un usuario a trav√©s de m√∫ltiples solicitudes.'
        ],
        correct_answer: 'Permitir que un servidor web mantenga informaci√≥n de estado sobre un usuario a trav√©s de m√∫ltiples solicitudes.',
        explanation: "Dado que HTTP es un protocolo **sin estado**, las cookies se utilizan para que el servidor pueda identificar a un usuario y recordar informaci√≥n sobre √©l (sesi√≥n, carrito de compras).",
        hint_if_wrong: " Recuerde que HTTP es un protocolo 'sin memoria del estado'. ¬øQu√© mecanismo le permitir√≠a 'recordar' a un usuario?",
        answer: null, checked: false, score_value: 1, topic: 'HTTP'
    },
    // Q19: DNS - Secci√≥n Respuestas
{ 
    id: 11, 
    type: 'tf', 
    text: "V/F: La secci√≥n 'Respuestas' (Answers) de un mensaje DNS contiene los Registros de Recursos (RR) que responden directamente a la consulta, como el mapeo entre nombre y direcci√≥n IP.",
    options: ['Verdadero', 'Falso'],
    correct_answer: 'Verdadero',
    explanation: "Verdadero. La secci√≥n 'Respuestas' de un mensaje DNS contiene los Registros de Recursos (RR) que son el resultado directo de la consulta (por ejemplo, el registro A con la direcci√≥n IP), mientras que la secci√≥n 'Cuestiones' contiene la pregunta",
    hint_if_wrong: "Analiza la estructura de un mensaje DNS: ¬øQu√© secci√≥n (Cuestiones, Respuestas o Autoridad) contiene la soluci√≥n final y directa que el cliente estaba buscando?",
    answer: null, 
    checked: false, 
    score_value: 1, 
    topic: 'DNS'},
// Q22: DRAG & DROP - Flujo de Correo SOBRE IMAGEN
// En tu HTML, dentro de window.FULL_QUIZ_BANK:
{ 
    id: 12, 
    type: 'drag_drop_image',

    text: "[IMG_SMTP_DIAGRAM] Arrastra los protocolos a las flechas correctas en el flujo de env√≠o de correo entre Alicia y Benito.",
    
    // Items que se pueden arrastrar
    drag_items: [
        { value: 'smtp_cliente', label: 'SMTP' },
        { value: 'smtp_transfer', label: 'SMTP (transferencia)' },
        { value: 'pop_imap_http', label: 'POP3 / IMAP / HTTP' }
    ],
    
    // Zonas de destino, con COORDENADAS ESTIMADAS... (deja esto igual)
      drop_zones: [

        // Zona 1: Flecha Agente -> Servidor Alicia

        { function: 'f1', label: 'Flecha 1', correct_protocol: 'smtp_cliente', x: '19%', y: '38%' },

        // Zona 2: Flecha Servidor Alicia -> Servidor Benito

        { function: 'f2', label: 'Flecha 2', correct_protocol: 'smtp_transfer', x: '45%', y: '38%' },

        // Zona 3: Flecha Servidor Benito -> Agente Benito

        { function: 'f3', label: 'Flecha 3', correct_protocol: 'pop_imap_http', x: '73%', y: '38%' }

    ],
    
      // Mapa correcto

    correct_map: { 

        'f1': 'smtp_cliente', 

        'f2': 'smtp_transfer', 

        'f3': 'pop_imap_http' 

    },

    answer: {}, checked: false, score_value: 1, topic: 'Correo',

    hint_if_wrong: "El proceso de env√≠o de un extremo al otro (Agente -> Servidor -> Servidor) usa diferentes protocolos que el proceso de acceso final (Servidor -> Agente).",
},
// Q23: DRAG & DROP - Jerarqu√≠a DNS

{ 
    id: 14, 
    type: 'mc', // Usamos MC para la clasificaci√≥n binaria
    text: "Observa la cabecera del siguiente mensaje HTTP. ¬øQu√© tipo de mensaje se est√° enviando? [IMG_HTTP_MESSAGE]",
    
    options: [
        'Mensaje de SOLICITUD (Request)',
        'Mensaje de RESPUESTA (Response)',
        //'Mensaje de Error (404/505)',
        //'Mensaje de Estado (Status)'
    ],
    correct_answer: 'Mensaje de SOLICITUD (Request)',
   explanation: "El mensaje comienza con el m√©todo GET, seguido de un URL y la versi√≥n HTTP/1.1. Esto es la estructura distintiva de la l√≠nea de Solicitud (Request line)",
    hint_if_wrong: "El primer campo de un mensaje de Solicitud es un M√©todo, mientras que un mensaje de Respuesta comienza con el c√≥digo de Estado",
    answer: null, checked: false, score_value: 1, topic: 'HTTP'
}

];

        // --- FUNCI√ìN DE SELECCI√ìN ALEATORIA ---
        function selectRandomQuestions(allQuestions, count) {
            // 1. Clonar el array para no modificar el original
            const shuffled = [...allQuestions];
            
            // 2. Mezclar el array (Algoritmo de Fisher-Yates)
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            // 3. Tomar las primeras 'count' preguntas
            const selected = shuffled.slice(0, count);

            // 4. Renumerar las preguntas de 1 a 10 y actualizar el texto P1, P2, etc.
            return selected.map((q, index) => {
                const newQ = { ...q, id: index + 1, checked: false, answer: null };
                // Actualizar el texto para que coincida con el nuevo n√∫mero de pregunta
                const match = newQ.text.match(/^(P|Q)\d+\./);
                if (match) {
                    newQ.text = `P${index + 1}.` + newQ.text.substring(match[0].length);
                }
                // Si no tiene prefijo (P o Q), usa P y el n√∫mero
                if (!match) {
                     newQ.text = `P${index + 1}. ${newQ.text}`;
                }
                return newQ;
            });
        }

        // --- ASIGNACI√ìN FINAL ---
        // ESTA L√çNEA ES CLAVE: Asigna las 10 preguntas aleatorias a la variable que el script externo lee.
        window.QUIZ_QUESTIONS = selectRandomQuestions(window.FULL_QUIZ_BANK, 10);
        
      </script>
      <script src="{% static 'aplicacion/estudiante/juego_capa_1.js' %}"></script>
    {% else %}
        <h1>Acceso Denegado</h1>
        <p>Necesitas iniciar sesi√≥n para ver esta p√°gina.</p>
    </div>
    {% endif %}
    
    <footer class="footer">
        <div class="footer-inner">
            <div class="footer-left">
                <p class="footer-brand">Aventura TCP/IP</p>
                <p class="footer-meta">
                    Desarrollado por: Coria Luz Antonella, Proserpio Eliana Naily y Ana Paula Machado
                </p>
                <p class="footer-meta">
                    Inform√°tica Educativa ¬∑ Licenciatura en Sistemas de Informaci√≥n ¬∑ UNSE ¬∑ 2025
                </p>
            </div>
            <div class="footer-right">
                <span class="footer-tag">Proyecto acad√©mico</span>
                <span class="footer-tag footer-role">Versi√≥n 1.0</span>
            </div>
             <div id="hint-card" class="hint-card hidden">
                <div class="hint-header">üí° PISTA</div>
                <div class="hint-body" id="hint-text"></div>
                <button class="hint-close-btn" onclick="hideHintCard()">Entendido ‚úî</button>
            </div>
        </div>
    </footer>
</body>
</html>