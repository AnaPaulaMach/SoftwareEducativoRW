{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Perfil del Estudiante</title>

    <!-- Cargamos los estilos externos -->
    <link rel="stylesheet" href="{% static 'aplicacion/style.css' %}">
</head>

<body>
    <script>
        // Limpieza inmediata: eliminar cualquier flag antiguo de desbloqueo antes de procesar la UI
        try { localStorage.removeItem('unlocked_level_2'); } catch (e) { /* ignore */ }
    </script>

    <!-- TTULO DE LA APLICACIN: FUERA de la tarjeta -->
    <h1 class="title">AVENTURA TCP/IP: CARRERA DE CAPAS </h1>
    <!-- Contenedor principal de la tarjeta de perfil -->

    <div class="profile-container">

        {% if user.is_authenticated %}

        <!-- CONTENEDOR DEL ALIAS Y ROL (MUESTRA INFORMACIN DEL PERFIL) -->
        <div class="profile-meta">
            <!-- Se accede al Alias (o Username por defecto) y al Rol -->
            Alias: <strong>{{ user.alias|default:user.username }}</strong> | Rol: {{ user.rol }}
            <br><br>
            <a style="background-color: transparent; color: #dc3545; border: 1px solid #dc3545;
                padding: 6px 15px;text-align: center;text-decoration: none;display: inline-block;font-size: 0.9em;
                cursor: pointer;border-radius: 5px;transition: all 0.3s;font-weight: normal;" href="{% url 'logout' %}"
                class="btn-cerrar-sesion">Cerrar Sesi贸n</a>
        </div>

        <div class="profile-header">
            <h1>隆Bienvenido/a, {{ user.first_name }} {{ user.last_name }}!</h1>
            <p><strong>Carrera:</strong> {{ clase.carrera }} || <strong>Materia:</strong> {{ clase.materia }} </p>
            <p><strong>Profesor:</strong> {{ clase.profesor.username }} || <strong>C贸digo de Clase:</strong>
                <strong>{{clase.codigo_acceso }}</strong></p>
                                            <hr style="margin-top: 30px;">

        </div>

        <!-- Secci贸n de Niveles del Juego -->
        <h3 style="text-align: center; color: #0077B6; margin-bottom: 30px;">Elige la Capa para Iniciar la Carrera</h3>

        <div class="game-levels">

            <!-- NIVEL 1: CAPA DE APLICACIN (Desbloqueado) -->
            {# Evaluamos estado del nivel seg煤n la configuraci贸n del profesor #}
            {% with nivel1=niveles_habilitados.1 %}
            <div class="level-card {% if nivel1 %}unlocked{% else %}locked{% endif %}">
                {% if not nivel1 %}
                <span class="locked-icon"></span>
                {% endif %}
                <h3>Nivel 1</h3>
                <p>Capa de Aplicaci贸n</p>
                <a href="{% if nivel1 %}{% url 'juego_capa_1' %}{% else %}#{% endif %}" class="level-button">
                    {% if nivel1 %}INICIAR{% else %}BLOQUEADO{% endif %}
                </a>
                {% if not nivel1 %}
                    <p class="level-note">Nivel bloqueado por el profesor.</p>
                {% endif %}
            </div>
            {% endwith %}

            <!-- NIVEL 2: CAPA DE TRANSPORTE -->
            {% with nivel2=niveles_habilitados.2 %}
            {% if puede_jugar_nivel_2 %}
            <div id="level-2-card" class="level-card unlocked">
                <h3>Nivel 2</h3>
                <p>Capa de Transporte</p>
                <a href="{% url 'juego_capa_2' %}" class="level-button" id="level-2-button">
                    INICIAR
                </a>
            </div>
            {% else %}
            <div id="level-2-card" class="level-card locked">
                <span class="locked-icon"></span>
                <h3>Nivel 2</h3>
                <p>Capa de Transporte</p>
                <a href="#" class="level-button" id="level-2-button">
                    BLOQUEADO
                </a>
                <p class="level-note">
                    {% if not nivel2 %}
                        Nivel bloqueado por el profesor.
                    {% else %}
                        Debes completar el nivel anterior para continuar.
                    {% endif %}
                </p>
            </div>
            {% endif %}
            {% endwith %}

            <!-- NIVEL 3: CAPA DE RED (Bloqueado) -->
            <div class="level-card locked">
                <span class="locked-icon"></span>
                <h3>Nivel 3</h3>
                <p>Capa de Red</p>
                <a href="#" class="level-button">
                    BLOQUEADO
                </a>
            </div>

            <!-- NIVEL 4: CAPA DE ENLACE (Bloqueado) -->
            <div class="level-card locked">
                <span class="locked-icon"></span>
                <h3>Nivel 4</h3>
                <p>Capa de Enlace</p>
                <a href="#" class="level-button">
                    BLOQUEADO
                </a>
            </div>

            <!-- NIVEL 5: CAPA FSICA (Bloqueado) -->
            <div class="level-card locked">
                <span class="locked-icon"></span>
                <h3>Nivel 5</h3>
                <p>Capa F铆sica</p>
                <a href="#" class="level-button">
                    BLOQUEADO
                </a>
            </div>

            <!-- Nivel FINAL -->
            <div class="level-card locked">
                <span class="locked-icon"></span>
                <h3>FINAL</h3>
                <p>Prueba Global</p>
                <a href="#" class="level-button">
                    BLOQUEADO
                </a>
            </div>
        </div>

        {% else %}
        <h1>Acceso Denegado</h1>
        <p>Necesitas iniciar sesi贸n para ver esta p谩gina.</p>
        {% endif %}

        <p style="margin-top:30px; text-align:center;">
            <a href="{% url 'salir_clase' %}" class="btn btn-warning">
                Salir e ingresar con otro c贸digo
            </a>

        </p>

    </div>

    <script>
        // Sincronizar localStorage con el estado del servidor.
        // Ya no permitimos que un valor antiguo en localStorage fuerce el desbloqueo.
        (function () {
            try {
                var serverUnlocked = "{{ unlocked_level_2|yesno:'true,false' }}" === "true";
                if (serverUnlocked) {
                    try { localStorage.setItem('unlocked_level_2', 'true'); } catch (e) { }
                } else {
                    try { localStorage.removeItem('unlocked_level_2'); } catch (e) { }
                }
            } catch (e) {
                console.warn('No se pudo sincronizar localStorage para desbloqueo de niveles.');
            }
        })();
    </script>

</body>

</html>